<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ZenBudget Pro</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ZenBudget">
    
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/6045/6045113.png">

    <style>
        :root {
            --bg: #050505;
            --card: #121217;
            --cyan: #00f2ff;
            --purple: #7000ff;
            --green: #00ff88;
            --red: #ff4d4d;
            --text: #ffffff;
            --dim: #888;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            /* Gestion de l'encoche et de la barre home de l'iPhone */
            padding: env(safe-area-inset-top) 20px calc(100px + env(safe-area-inset-bottom)) 20px;
        }

        /* Navigation */
        .nav {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: rgba(18, 18, 23, 0.95);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            display: flex;
            justify-content: space-around;
            padding: 15px 0 calc(10px + env(safe-area-inset-bottom)) 0;
            border-top: 1px solid #333;
            z-index: 1000;
        }

        .nav-btn { color: var(--dim); border: none; background: none; font-size: 11px; font-weight: 600; cursor: pointer; letter-spacing: 0.5px; }
        .nav-btn.active { color: var(--cyan); }

        /* Écrans */
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Jauge Circulaire */
        .gauge-container {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 25px auto;
        }

        svg { transform: rotate(-90deg); filter: drop-shadow(0 0 8px rgba(0, 242, 255, 0.2)); }
        .circle-bg { fill: none; stroke: #1a1a1a; stroke-width: 12; }
        .circle-progress {
            fill: none;
            stroke-width: 12;
            stroke-linecap: round;
            transition: stroke-dasharray 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .gauge-text {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        /* Cartes */
        .card {
            background: var(--card);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #222;
        }

        .amount-big { font-size: 32px; font-weight: 800; color: var(--cyan); margin: 5px 0; letter-spacing: -1px; }
        
        input {
            width: 100%;
            padding: 16px;
            margin: 10px 0;
            background: #1e1e24;
            border: 1px solid #333;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            outline: none;
            box-sizing: border-box;
        }

        input:focus { border-color: var(--cyan); }

        button.main-btn {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: none;
            font-weight: 700;
            font-size: 16px;
            margin-top: 5px;
            transition: opacity 0.2s;
        }

        .btn-add { background: var(--green); color: #000; }
        .btn-rem { background: var(--red); color: #000; }
        .btn-lock { background: var(--purple); color: #fff; margin-bottom: 10px; }
        button:disabled { opacity: 0.2; }

        /* Liste Transactions */
        .tx-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #1a1a1a;
        }
        .tx-info { font-size: 15px; font-weight: 500; }
        .tx-date { font-size: 12px; color: var(--dim); margin-top: 2px; }

        /* Calendrier */
        .cal-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            text-align: center;
        }
        .cal-day {
            padding: 12px 0;
            border-radius: 10px;
            font-size: 14px;
            background: #1a1a20;
            transition: all 0.2s;
        }
        .today { background: var(--purple); color: white; border: 1px solid var(--cyan); }
        .selected { border: 2px solid var(--cyan); background: #2a2a35; }
    </style>
</head>
<body>

    <div id="scr-global" class="screen active">
        <h1 style="text-align:center">Global</h1>
        <div class="gauge-container">
            <svg width="200" height="200">
                <circle class="circle-bg" cx="100" cy="100" r="85"></circle>
                <circle id="gauge-global" class="circle-progress" cx="100" cy="100" r="85" stroke="var(--cyan)"></circle>
            </svg>
            <div class="gauge-text">
                <div style="font-size:12px; color:var(--dim)">TOTAL SOLDE</div>
                <div id="val-global-bal" class="amount-big">0€</div>
            </div>
        </div>
        <div style="display:flex; justify-content:space-between; text-align:center">
            <div>Gains<br><span id="val-global-in" style="color:var(--green)">0€</span></div>
            <div>Dépenses<br><span id="val-global-out" style="color:var(--red)">0€</span></div>
        </div>
        <h3 style="margin-top:30px">Historique</h3>
        <div id="list-global"></div>
    </div>

    <div id="scr-budget" class="screen">
        <h1 style="text-align:center">Budget</h1>
        <div class="card">
            <input type="number" id="in-budget-limit" placeholder="Limite mensuelle (ex: 500)">
            <button id="btn-lock" class="main-btn btn-lock" onclick="lockBudget()">Valider la limite</button>
            <div class="gauge-container">
                <svg width="200" height="200">
                    <circle class="circle-bg" cx="100" cy="100" r="85"></circle>
                    <circle id="gauge-budget" class="circle-progress" cx="100" cy="100" r="85" stroke="var(--purple)"></circle>
                </svg>
                <div class="gauge-text">
                    <div id="val-budget-left" class="amount-big">0€</div>
                    <div style="font-size:12px; color:var(--dim)">RESTANT</div>
                </div>
            </div>
        </div>
        <div class="card">
            <input type="text" id="tx-name" placeholder="Nom">
            <input type="number" id="tx-amount" placeholder="Montant">
            <div style="display:flex; gap:10px">
                <button class="main-btn btn-add" onclick="addTx('in')">+ Entrée</button>
                <button class="main-btn btn-rem" onclick="addTx('out')">- Dépense</button>
            </div>
        </div>
        <div id="list-budget"></div>
    </div>

    <div id="scr-cal" class="screen">
        <h1 id="cal-month" style="text-align:center">Janvier</h1>
        <div class="card cal-grid" id="cal-days"></div>
        <div id="cal-details" class="card" style="min-height: 100px;">Sélectionnez un jour</div>
    </div>

    <nav class="nav">
        <button class="nav-btn active" onclick="nav('scr-global', this)">GLOBAL</button>
        <button class="nav-btn" onclick="nav('scr-budget', this)">BUDGET</button>
        <button class="nav-btn" onclick="nav('scr-cal', this)">CALENDRIER</button>
    </nav>

    <script>
        // DONNÉES
        let state = JSON.parse(localStorage.getItem('zenbudget_db')) || {
            base: 1047.92,
            limit: 0,
            lockedUntil: null,
            tx: []
        };

        const radius = 85;
        const circumference = 2 * Math.PI * radius;

        function save() {
            localStorage.setItem('zenbudget_db', JSON.stringify(state));
            refresh();
        }

        function nav(id, btn) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
            if(id === 'scr-cal') renderCal();
        }

        function addTx(type) {
            const n = document.getElementById('tx-name').value;
            const a = parseFloat(document.getElementById('tx-amount').value);
            if(!n || !a) return;
            state.tx.push({ name: n, amount: type === 'out' ? -a : a, date: new Date().toISOString() });
            document.getElementById('tx-name').value = '';
            document.getElementById('tx-amount').value = '';
            save();
        }

        function lockBudget() {
            const val = parseFloat(document.getElementById('in-budget-limit').value);
            if(!val) return;
            state.limit = val;
            let d = new Date();
            state.lockedUntil = new Date(d.getFullYear(), d.getMonth() + 1, 1).toISOString();
            save();
        }

        function refresh() {
            // Calculs
            const totalIn = state.tx.filter(t => t.amount > 0).reduce((a, b) => a + b.amount, 0);
            const totalOut = state.tx.filter(t => t.amount < 0).reduce((a, b) => a + Math.abs(b.amount), 0);
            const currentBal = state.base + totalIn - totalOut;
            
            // UI Global
            document.getElementById('val-global-bal').innerText = currentBal.toFixed(2) + '€';
            document.getElementById('val-global-in').innerText = '+' + totalIn.toFixed(2) + '€';
            document.getElementById('val-global-out').innerText = '-' + totalOut.toFixed(2) + '€';
            
            const gCircle = document.getElementById('gauge-global');
            const gPercent = Math.min(100, (currentBal / (state.base * 2)) * 100); 
            updateCircle(gCircle, gPercent);

            // UI Budget
            const now = new Date();
            const monthlyTx = state.tx.filter(t => {
                const d = new Date(t.date);
                return d.getMonth() === now.getMonth() && t.amount < 0;
            });
            const spent = monthlyTx.reduce((a, b) => a + Math.abs(b.amount), 0);
            const left = state.limit - spent;
            
            document.getElementById('val-budget-left').innerText = left.toFixed(2) + '€';
            const bCircle = document.getElementById('gauge-budget');
            const bPercent = state.limit > 0 ? Math.max(0, (left / state.limit) * 100) : 0;
            updateCircle(bCircle, bPercent);

            // Verrouillage
            const isLocked = state.lockedUntil && new Date(state.lockedUntil) > now;
            document.getElementById('in-budget-limit').disabled = isLocked;
            document.getElementById('btn-lock').disabled = isLocked;
            if(isLocked) document.getElementById('in-budget-limit').value = state.limit;

            renderList('list-global', state.tx);
            renderList('list-budget', state.tx);
        }

        function updateCircle(el, percent) {
            el.style.strokeDasharray = `${circumference} ${circumference}`;
            const offset = circumference - (percent / 100) * circumference;
            el.style.strokeDashoffset = offset;
        }

        function renderList(id, items) {
            document.getElementById(id).innerHTML = items.slice().reverse().map(t => `
                <div class="tx-item">
                    <div class="tx-info">${t.name}<br><span class="tx-date">${new Date(t.date).toLocaleDateString()}</span></div>
                    <div style="color:${t.amount > 0 ? 'var(--green)' : 'var(--red)'}">${t.amount > 0 ? '+' : ''}${t.amount}€</div>
                </div>
            `).join('');
        }

        function renderCal() {
            const grid = document.getElementById('cal-days');
            grid.innerHTML = '';
            const now = new Date();
            document.getElementById('cal-month').innerText = now.toLocaleDateString('fr-FR', {month:'long', year:'numeric'});
            
            for(let i = 1; i <= 31; i++) {
                const d = new Date(now.getFullYear(), now.getMonth(), i);
                if(d.getMonth() !== now.getMonth()) break;
                
                const dayEl = document.createElement('div');
                dayEl.className = 'cal-day' + (d.toDateString() === now.toDateString() ? ' today' : '');
                dayEl.innerText = i;
                dayEl.onclick = () => {
                    document.querySelectorAll('.cal-day').forEach(el => el.classList.remove('selected'));
                    dayEl.classList.add('selected');
                    showDay(d);
                };
                grid.appendChild(dayEl);
            }
        }

        function showDay(date) {
            const dayTx = state.tx.filter(t => new Date(t.date).toDateString() === date.toDateString());
            document.getElementById('cal-details').innerHTML = dayTx.length ? 
                dayTx.map(t => `<div class="tx-item"><span>${t.name}</span><b>${t.amount}€</b></div>`).join('') : 
                "Rien pour ce jour";
        }

        refresh();
    </script>
</body>
</html>
