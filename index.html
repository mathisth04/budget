<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ZenBudget Pro</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://img.icons8.com/ios-filled/512/00f2ff/b-filled.png">

    <style>
        :root { --bg: #050505; --card: #121217; --cyan: #00f2ff; --purple: #7000ff; --green: #00ff88; --red: #ff4d4d; --gray: #666; }
        * { -webkit-tap-highlight-color: transparent; outline: none; box-sizing: border-box; }

        body { 
            font-family: -apple-system, sans-serif; 
            background: var(--bg); color: #fff; margin: 0; 
            padding: env(safe-area-inset-top) 20px 120px 20px;
            overflow-x: hidden;
        }

        /* Nav */
        .nav { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            height: calc(70px + env(safe-area-inset-bottom)); 
            background: rgba(17, 17, 17, 0.95); display: flex; z-index: 1000;
            border-top: 1px solid #333; backdrop-filter: blur(10px);
        }
        .nav-btn { 
            flex: 1; border: none; background: none; color: var(--gray); 
            font-size: 11px; font-weight: bold; text-transform: uppercase;
        }
        .nav-btn.active { color: var(--cyan); }

        /* Ecrans */
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Jauges */
        .gauge { position: relative; width: 200px; height: 200px; margin: 10px auto; }
        svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .bg-ring { fill: none; stroke: #1a1a1a; stroke-width: 12; }
        .fill-ring { fill: none; stroke-width: 12; stroke-linecap: round; transition: 1s cubic-bezier(0.4, 0, 0.2, 1); }
        .gauge-data { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; width: 100%; }

        /* Calendrier */
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .cal-day { 
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center; 
            border-radius: 50%; font-size: 14px; position: relative; color: #ccc;
        }
        .cal-day.today { border: 2px solid var(--cyan); color: var(--cyan); font-weight: bold; }
        .cal-day.selected { background: var(--purple); color: white; }
        .cal-day.has-tx::after { 
            content: ''; position: absolute; bottom: 4px; width: 4px; height: 4px; 
            background: var(--green); border-radius: 50%; 
        }

        /* UI Elements */
        .card { background: var(--card); border-radius: 20px; padding: 20px; margin-bottom: 15px; border: 1px solid #222; }
        input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; background: #1e1e24; color: #fff; border: 1px solid #444; font-size: 16px; }
        .btn-ios { width: 100%; padding: 18px; border-radius: 14px; border: none; font-size: 16px; font-weight: 800; margin: 10px 0; color: #fff; text-transform: uppercase; cursor: pointer;}
        .btn-ios:disabled { background: #333; color: #666; cursor: not-allowed; }
        .purple { background: var(--purple); }
        .green { background: var(--green); color: #000; }
        .red { background: var(--red); color: #000; }
        .gray-btn { background: #333; color: #fff; font-size: 12px; padding: 10px; }
        .tx-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #222; font-size: 14px; }
    </style>
</head>
<body>

    <div id="scr-global" class="screen active">
        <h2 style="text-align:center">Solde Actuel</h2>
        <div class="gauge">
            <svg viewBox="0 0 200 200">
                <circle class="bg-ring" cx="100" cy="100" r="85"></circle>
                <circle id="ring-global" class="fill-ring" cx="100" cy="100" r="85" stroke="var(--cyan)"></circle>
            </svg>
            <div class="gauge-data"><small>TOTAL</small><br><b id="txt-global" style="font-size:24px">0‚Ç¨</b></div>
        </div>
        <div id="list-global" class="card"></div>
    </div>

    <div id="scr-budget" class="screen">
        <h2 style="text-align:center">Budget Mensuel</h2>
        <div class="gauge">
            <svg viewBox="0 0 200 200">
                <circle class="bg-ring" cx="100" cy="100" r="85"></circle>
                <circle id="ring-budget-rem" class="fill-ring" cx="100" cy="100" r="85" stroke="var(--green)"></circle>
            </svg>
            <div class="gauge-data"><small>RESTANT</small><br><b id="txt-budget-rem" style="font-size:24px">0‚Ç¨</b></div>
        </div>
        <div class="card">
            <div id="budget-lock-msg" style="font-size:11px; color:var(--red); text-align:center; margin-bottom:5px;"></div>
            <input type="number" id="limit-input" placeholder="Montant du budget">
            <button class="btn-ios purple" id="save-limit">Valider le budget</button>
        </div>
        <div class="card">
            <input type="text" id="op-name" placeholder="Nom de l'op√©ration">
            <input type="number" id="op-amount" placeholder="Montant">
            <button class="btn-ios green" id="add-gain">+ Entr√©e d'argent</button>
            <button class="btn-ios red" id="add-loss">- D√©pense</button>
        </div>
    </div>

    <div id="scr-cal" class="screen">
        <h2 style="text-align:center">Calendrier</h2>
        <div class="card">
            <div class="cal-header">
                <button style="background:none; border:none; color:var(--cyan); font-size:20px;" id="prevMonth">‚óÄ</button>
                <b id="cal-month-title">Janvier 2024</b>
                <button style="background:none; border:none; color:var(--cyan); font-size:20px;" id="nextMonth">‚ñ∂</button>
            </div>
            <div class="cal-grid" id="cal-grid"></div>
        </div>
        <div class="card" id="cal-details">
            <small style="color:var(--gray)">Cliquez sur un jour pour voir le d√©tail</small>
        </div>
        <button class="btn-ios gray-btn" id="export-csv">üì• Exporter l'historique (CSV)</button>
    </div>

    <nav class="nav">
        <button class="nav-btn active" id="nav-1">Global</button>
        <button class="nav-btn" id="nav-2">Budget</button>
        <button class="nav-btn" id="nav-3">Calendrier</button>
    </nav>

    <script>
        let db = JSON.parse(localStorage.getItem('zenbudget_db')) || { 
            base: 1047.92, 
            limit: 0, 
            limitDate: null, 
            tx: [] 
        };
        
        const circ = 2 * Math.PI * 85;
        let currentCalDate = new Date();
        let selectedDateStr = null;

        function checkBudgetLock() {
            const btn = document.getElementById('save-limit');
            const msg = document.getElementById('budget-lock-msg');
            const input = document.getElementById('limit-input');
            if (db.limitDate) {
                const lastLock = new Date(db.limitDate);
                const now = new Date();
                if (lastLock.getMonth() === now.getMonth() && lastLock.getFullYear() === now.getFullYear()) {
                    btn.disabled = true; input.disabled = true;
                    msg.innerText = "üîí Verrouill√© jusqu'au 1er du mois prochain.";
                    return;
                }
            }
            btn.disabled = false; input.disabled = false; msg.innerText = "";
        }

        function refresh() {
            const out = db.tx.filter(t => t.a < 0).reduce((s, t) => s + Math.abs(t.a), 0);
            const ins = db.tx.filter(t => t.a > 0).reduce((s, t) => s + t.a, 0);
            const bal = db.base + ins - out;

            document.getElementById('txt-global').innerText = bal.toFixed(2) + '‚Ç¨';
            const pctGlobal = Math.min(100, (bal/2500)*100);
            document.getElementById('ring-global').style.strokeDasharray = circ;
            document.getElementById('ring-global').style.strokeDashoffset = circ - (pctGlobal/100)*circ;

            const remBudget = db.limit - out + ins;
            document.getElementById('txt-budget-rem').innerText = remBudget.toFixed(2) + '‚Ç¨';
            const pctBudget = db.limit > 0 ? Math.max(0, Math.min(100, (remBudget / db.limit) * 100)) : 0;
            const rBudget = document.getElementById('ring-budget-rem');
            rBudget.style.strokeDasharray = circ;
            rBudget.style.strokeDashoffset = circ - (pctBudget/100)*circ;
            rBudget.style.stroke = pctBudget < 15 ? 'var(--red)' : 'var(--green)';

            const listHtml = db.tx.slice(-5).reverse().map(t => `<div class="tx-row"><span>${t.n}</span><b>${t.a}‚Ç¨</b></div>`).join('');
            document.getElementById('list-global').innerHTML = "<b>Activit√©s r√©centes :</b><br>" + (listHtml || "Aucune");

            checkBudgetLock();
            renderCalendar();
            localStorage.setItem('zenbudget_db', JSON.stringify(db));
        }

        function renderCalendar() {
            const grid = document.getElementById('cal-grid');
            const title = document.getElementById('cal-month-title');
            grid.innerHTML = "";
            const month = currentCalDate.getMonth();
            const year = currentCalDate.getFullYear();
            title.innerText = new Intl.DateTimeFormat('fr-FR', { month: 'long', year: 'numeric' }).format(currentCalDate);
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for(let i = 0; i < (firstDay === 0 ? 6 : firstDay - 1); i++) grid.appendChild(document.createElement('div'));
            const today = new Date().toLocaleDateString('fr-FR');
            for(let d = 1; d <= daysInMonth; d++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'cal-day';
                const dateStr = `${d.toString().padStart(2, '0')}/${(month+1).toString().padStart(2, '0')}/${year}`;
                dayEl.innerText = d;
                if(dateStr === today) dayEl.classList.add('today');
                if(dateStr === selectedDateStr) dayEl.classList.add('selected');
                if(db.tx.some(t => t.d === dateStr)) dayEl.classList.add('has-tx');
                dayEl.onclick = () => { selectedDateStr = dateStr; showDayDetails(dateStr); renderCalendar(); };
                grid.appendChild(dayEl);
            }
        }

        function showDayDetails(dateStr) {
            const dayTx = db.tx.filter(t => t.d === dateStr);
            const container = document.getElementById('cal-details');
            if(dayTx.length === 0) container.innerHTML = `<b>${dateStr}</b><br><small>Aucun mouvement.</small>`;
            else container.innerHTML = `<b>${dateStr}</b><br>` + dayTx.map(t => `<div class="tx-row"><span>${t.n}</span><b>${t.a}‚Ç¨</b></div>`).join('');
        }

        function exportToCSV() {
            if (db.tx.length === 0) { alert("Aucune donn√©e √† exporter."); return; }
            let csvContent = "data:text/csv;charset=utf-8,Date,Nom,Montant\n";
            db.tx.forEach(t => { csvContent += `${t.d},${t.n},${t.a}\n`; });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `ZenBudget_Export_${new Date().getMonth()+1}_${new Date().getFullYear()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function setupBtn(id, action) {
            const el = document.getElementById(id);
            const handler = (e) => { e.preventDefault(); document.activeElement.blur(); action(); refresh(); };
            el.addEventListener('touchend', handler);
            el.addEventListener('click', (e) => { if(e.pointerType !== 'touch') handler(e); });
        }

        window.onload = () => {
            setupBtn('nav-1', () => switchScr('scr-global', 'nav-1'));
            setupBtn('nav-2', () => switchScr('scr-budget', 'nav-2'));
            setupBtn('nav-3', () => switchScr('scr-cal', 'nav-3'));
            setupBtn('save-limit', () => {
                const v = parseFloat(document.getElementById('limit-input').value);
                if(v > 0) { db.limit = v; db.limitDate = new Date().toISOString(); alert("Budget fix√© !"); }
            });
            setupBtn('add-gain', () => {
                const n = document.getElementById('op-name').value || "Revenu";
                const a = parseFloat(document.getElementById('op-amount').value);
                if(a) db.tx.push({n, a, d: new Date().toLocaleDateString('fr-FR')});
            });
            setupBtn('add-loss', () => {
                const n = document.getElementById('op-name').value || "D√©pense";
                const a = parseFloat(document.getElementById('op-amount').value);
                if(a) db.tx.push({n, a: -a, d: new Date().toLocaleDateString('fr-FR')});
            });
            setupBtn('export-csv', exportToCSV);

            document.getElementById('prevMonth').onclick = () => { currentCalDate.setMonth(currentCalDate.getMonth() - 1); renderCalendar(); };
            document.getElementById('nextMonth').onclick = () => { currentCalDate.setMonth(currentCalDate.getMonth() + 1); renderCalendar(); };

            let touchstartX = 0;
            document.getElementById('scr-cal').addEventListener('touchstart', e => touchstartX = e.changedTouches[0].screenX);
            document.getElementById('scr-cal').addEventListener('touchend', e => {
                let x = e.changedTouches[0].screenX;
                if (touchstartX - x > 60) document.getElementById('nextMonth').click();
                if (x - touchstartX > 60) document.getElementById('prevMonth').click();
            });
            refresh();
        };

        function switchScr(sid, bid) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(sid).classList.add('active');
            document.getElementById(bid).classList.add('active');
        }
    </script>
</body>
</html>
