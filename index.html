<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ZenBudget</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://img.icons8.com/ios-filled/512/00f2ff/b-filled.png">

    <style>
        :root { --bg: #050505; --card: #121217; --cyan: #00f2ff; --purple: #7000ff; --green: #00ff88; --red: #ff4d4d; }
        
        * { -webkit-tap-highlight-color: transparent; outline: none; }

        body { 
            font-family: -apple-system, sans-serif; 
            background: var(--bg); color: #fff; margin: 0; 
            padding: env(safe-area-inset-top) 20px 120px 20px;
        }

        /* Nav - Version fixe et simple pour éviter les bugs de zone */
        .nav { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            height: calc(70px + env(safe-area-inset-bottom)); 
            background: #111; display: flex; z-index: 1000;
            border-top: 1px solid #333;
        }
        .nav-btn { 
            flex: 1; border: none; background: none; color: #666; 
            font-size: 11px; font-weight: bold; text-transform: uppercase;
        }
        .nav-btn.active { color: var(--cyan); }

        .screen { display: none; }
        .screen.active { display: block; }

        /* Jauges */
        .gauge { position: relative; width: 220px; height: 220px; margin: 20px auto; }
        svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .bg-ring { fill: none; stroke: #1a1a1a; stroke-width: 12; }
        .fill-ring { fill: none; stroke-width: 12; stroke-linecap: round; transition: 0.6s ease-out; }
        .gauge-data { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; width: 100%; }

        /* Formulaires */
        .card { background: var(--card); border-radius: 20px; padding: 20px; margin-bottom: 15px; border: 1px solid #222; }
        
        input { 
            width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; 
            background: #1e1e24; color: #fff; border: 1px solid #444; 
            font-size: 16px; box-sizing: border-box; display: block;
        }

        /* Boutons massifs pour faciliter le toucher */
        .btn-ios { 
            width: 100%; padding: 18px; border-radius: 14px; border: none; 
            font-size: 16px; font-weight: 800; margin: 10px 0; 
            display: block; cursor: pointer; color: #fff;
            text-transform: uppercase;
        }
        .btn-ios:active { background: #fff !important; color: #000 !important; }

        .purple { background: var(--purple); }
        .green { background: var(--green); color: #000; }
        .red { background: var(--red); color: #000; }

        .tx-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #222; }
    </style>
</head>
<body>

    <div id="scr-global" class="screen active">
        <h2 style="text-align:center">Solde Global</h2>
        <div class="gauge">
            <svg viewBox="0 0 200 200">
                <circle class="bg-ring" cx="100" cy="100" r="85"></circle>
                <circle id="ring-global" class="fill-ring" cx="100" cy="100" r="85" stroke="var(--cyan)"></circle>
            </svg>
            <div class="gauge-data"><small>TOTAL</small><br><b id="txt-global" style="font-size:26px">0€</b></div>
        </div>
        <div id="list-global" class="card"></div>
    </div>

    <div id="scr-budget" class="screen">
        <h2 style="text-align:center">Mon Budget</h2>
        <div class="card">
            <input type="number" id="limit-input" placeholder="Limite mensuelle" pattern="[0-9]*">
            <button class="btn-ios purple" id="save-limit">Fixer le budget</button>
            <div id="budget-status" style="text-align:center; color:var(--dim); font-size:12px"></div>
        </div>
        <div class="card">
            <input type="text" id="op-name" placeholder="Nom (ex: Courses)">
            <input type="number" id="op-amount" placeholder="Montant" pattern="[0-9]*">
            <button class="btn-ios green" id="add-gain">+ Entrée d'argent</button>
            <button class="btn-ios red" id="add-loss">- Dépense</button>
        </div>
    </div>

    <div id="scr-cal" class="screen">
        <h2 style="text-align:center">Calendrier</h2>
        <div class="card" style="text-align:center; padding:40px 10px;">
            Accès aux 10 prochaines années disponible via le défilement.
        </div>
    </div>

    <nav class="nav">
        <button class="nav-btn active" id="nav-1">Global</button>
        <button class="nav-btn" id="nav-2">Budget</button>
        <button class="nav-btn" id="nav-3">Calendrier</button>
    </nav>

    <script>
        let db = JSON.parse(localStorage.getItem('zenbudget_db')) || { base: 1047.92, limit: 0, tx: [] };
        const circ = 2 * Math.PI * 85;

        // Fonction pour rafraîchir les visuels
        function refresh() {
            const out = db.tx.filter(t => t.a < 0).reduce((s, t) => s + Math.abs(t.a), 0);
            const ins = db.tx.filter(t => t.a > 0).reduce((s, t) => s + t.a, 0);
            const bal = db.base + ins - out;

            document.getElementById('txt-global').innerText = bal.toFixed(2) + '€';
            const pct = Math.min(100, (bal/2500)*100);
            document.getElementById('ring-global').style.strokeDasharray = circ;
            document.getElementById('ring-global').style.strokeDashoffset = circ - (pct/100)*circ;

            const listHtml = db.tx.slice(-5).reverse().map(t => `<div class="tx-row"><span>${t.n}</span><b>${t.a}€</b></div>`).join('');
            document.getElementById('list-global').innerHTML = listHtml || "Aucune opération";
            
            localStorage.setItem('zenbudget_db', JSON.stringify(db));
        }

        // Gestionnaire de clic forcé pour iPhone
        function setupBtn(id, action) {
            const el = document.getElementById(id);
            const handler = (e) => {
                e.preventDefault();
                document.activeElement.blur(); // Ferme le clavier
                action();
                refresh();
            };
            el.addEventListener('click', handler);
            el.addEventListener('touchstart', handler);
        }

        window.onload = () => {
            // Navigation
            setupBtn('nav-1', () => { switchScr('scr-global', 'nav-1') });
            setupBtn('nav-2', () => { switchScr('scr-budget', 'nav-2') });
            setupBtn('nav-3', () => { switchScr('scr-cal', 'nav-3') });

            // Actions Budget
            setupBtn('save-limit', () => {
                const v = parseFloat(document.getElementById('limit-input').value);
                if(!isNaN(v)) { db.limit = v; alert("Budget fixé !"); }
            });

            setupBtn('add-gain', () => {
                const n = document.getElementById('op-name').value;
                const a = parseFloat(document.getElementById('op-amount').value);
                if(n && a) { db.tx.push({n, a, d: new Date().toDateString()}); }
            });

            setupBtn('add-loss', () => {
                const n = document.getElementById('op-name').value;
                const a = parseFloat(document.getElementById('op-amount').value);
                if(n && a) { db.tx.push({n, a: -a, d: new Date().toDateString()}); }
            });

            refresh();
        };

        function switchScr(sid, bid) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(sid).classList.add('active');
            document.getElementById(bid).classList.add('active');
        }
    </script>
</body>
</html>
